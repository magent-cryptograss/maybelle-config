---
- name: Clone or update maybelle-config repository
  git:
    repo: https://github.com/cryptograss/maybelle-config.git
    dest: "{{ base_dir }}/maybelle-config"
    version: production
    force: yes
    update: yes

- name: Force fetch latest changes from production branch
  shell: git fetch origin production && git reset --hard origin/production
  args:
    chdir: "{{ base_dir }}/maybelle-config"

- name: Clone or update memory-lane repository (for watcher)
  git:
    repo: https://github.com/jMyles/memory-lane.git
    dest: "{{ base_dir }}/memory-lane-source"
    version: main
    force: yes
    update: yes

- name: Force fetch latest memory-lane changes from main branch
  shell: git fetch origin main && git reset --hard origin/main
  args:
    chdir: "{{ base_dir }}/memory-lane-source"

- name: Clone or update magenta repository (for shared CLAUDE.md)
  git:
    repo: https://github.com/magent-cryptograss/magenta.git
    dest: "{{ base_dir }}/magenta-source"
    version: main
    force: yes
    update: yes

- name: Force fetch latest magenta changes from main branch
  shell: git fetch origin main && git reset --hard origin/main
  args:
    chdir: "{{ base_dir }}/magenta-source"

- name: Get docker group GID from host
  shell: "getent group docker | cut -d: -f3"
  register: docker_gid

- name: Build magenta-arthel base image
  command: docker compose -f docker-compose-build.yml build --build-arg DOCKER_GID={{ docker_gid.stdout }}
  args:
    chdir: "{{ base_dir }}/maybelle-config/hunter"

- name: Verify image was built
  command: docker images magenta-arthel:latest --format "{% raw %}{{.Repository}}:{{.Tag}}{% endraw %}"
  register: image_check
  failed_when: "'magenta-arthel:latest' not in image_check.stdout"
