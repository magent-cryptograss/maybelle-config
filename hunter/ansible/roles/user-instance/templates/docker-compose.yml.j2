version: '3.8'

services:
  {{ user.name }}-arthel:
    image: magenta-arthel:latest  # Uses pre-built image, no build step
    container_name: {{ user.name }}-arthel
    hostname: {{ user.name }}@hunter
    ports:
      - "{{ user.ssh_port }}:22"
      # code-server web IDE (18080 for justin, 18081 for rj, etc.)
      - "{{ 18080 + (user.ssh_port - 2222) }}:8080"
      # Port range: {{ user.port_range_start }}-{{ user.port_range_start + 9 }}
      # Maps to container ports 4000-4009
      - "{{ user.port_range_start }}-{{ user.port_range_start + 9 }}:4000-4009"
      # Mosh UDP port range (60000-61000 in container, mapped to unique range per user)
      - "{{ user.mosh_port_start | default(60000 + (user.ssh_port - 2222) * 100) }}-{{ user.mosh_port_start | default(60000 + (user.ssh_port - 2222) * 100) + 99 }}:60000-60099/udp"
    volumes:
      # Mount entire home directory to persist workspace, .claude, bash history, etc
      - {{ base_dir }}/{{ user.name }}/home:/home/magent
      # SSH keys and git config mounted separately (read-only for security)
      - {{ base_dir }}/{{ user.name }}/.ssh:/home/magent/.ssh:ro
      - {{ base_dir }}/{{ user.name }}/.gitconfig:/home/magent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - magenta-net
    environment:
      - DEVELOPER_NAME={{ user.name }}
      - DEVELOPER_FULL_NAME={{ user.full_name }}
      - DEVELOPER_EMAIL={{ user.email }}
      - DEVELOPER_GITHUB={{ user.github_username }}
      - POSTGRES_HOST=magenta-postgres
      - POSTGRES_DB={{ postgres_db }}
      - POSTGRES_USER=magent
      - POSTGRES_PASSWORD={{ postgres_password }}
      - CODE_SERVER_PASSWORD={{ user.code_server_password }}
      - GH_TOKEN={{ user.github_token | default('') }}
      - DJANGO_SECRET_KEY={{ user.django_secret_key | default('') }}
      # Use private network for MCP on hunter (10.0.0.2 is maybelle)
      - MCP_MEMORY_URL=http://10.0.0.2:8000
    restart: unless-stopped

networks:
  magenta-net:
    external: true
    name: magenta-net
