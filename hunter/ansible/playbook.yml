---
# Hunter: Multi-user development environment
# PostgreSQL and Memory Lane services are now on maybelle
# Hunter runs: user containers, watcher (posting to maybelle)
- name: Setup Magenta Multi-User Development Environment
  hosts: hunter
  become: yes
  any_errors_fatal: true
  vars_files:
    - ../../secrets/vault.yml

  vars:
    caddy_config_type: "hunter"  # Use hunter-specific Caddyfile template

  tasks:
    - name: Ensure base directory exists
      file:
        path: "{{ base_dir }}"
        state: directory
        mode: '0755'

    - name: Include Security role (SSH hardening, fail2ban, firewall)
      include_role:
        name: security

    - name: Include Docker role
      include_role:
        name: docker

    - name: Build magenta-arthel base image
      include_role:
        name: build-image

    - name: Include Caddy role for reverse proxy
      include_role:
        name: caddy

    - name: Include SSH router role
      include_role:
        name: ssh-router

    - name: Include services role (watcher posting to maybelle)
      include_role:
        name: services

    - name: Create magenta-net docker network
      command: docker network create magenta-net
      register: network_create
      failed_when: network_create.rc != 0 and 'already exists' not in network_create.stderr
      changed_when: network_create.rc == 0

    - name: Include user-instance role for each user
      include_role:
        name: user-instance
      loop: "{{ users }}"
      loop_control:
        loop_var: user

    - name: Display deployment summary
      debug:
        msg: |
          ============================================
          HUNTER DEPLOYMENT COMPLETE
          ============================================
          PostgreSQL: maybelle (10.0.0.2)
          Memory Lane: https://memory-lane.maybelle.cryptograss.live
          MCP Server: http://10.0.0.2:8000
          Watcher: posting to maybelle ingest endpoint

          User instances deployed:
          {% for user in users %}
          - {{ user.name }}: ssh {{ user.name }}@hunter.cryptograss.live (port {{ user.ssh_port }})
          {% endfor %}

          Next steps:
          - SSH to container: ssh justin@hunter.cryptograss.live
          - Test MCP bootstrap on fresh Claude Code session
          ============================================
