---
- name: Setup Magenta Multi-User Development Environment
  hosts: hunter
  become: yes
  vars_files:
    - ../../secrets/vault.yml

  vars:
    caddy_config_type: "hunter"  # Use hunter-specific Caddyfile template

  tasks:
    - name: Validate database backup file exists (fail early)
      stat:
        path: "{{ db_dump_file }}"
      register: backup_file_check
      delegate_to: localhost
      become: no
      failed_when: not backup_file_check.stat.exists
      when: db_dump_file is defined

    - name: Warn if database backup was not provided
      debug:
        msg: |
          WARNING: No database backup file provided.
          Skipping data migration. Existing database will be preserved.
          To include database migration, run with: -e "db_dump_file=/path/to/backup.dump"
      when: db_dump_file is not defined

    - name: Start copying database backup to hunter (async)
      shell: |
        rsync -az "{{ db_dump_file }}" "{{ ansible_user }}@{{ ansible_host | default(inventory_hostname) }}:/tmp/magenta_memory.dump" 2>&1 | tail -1
      delegate_to: localhost
      become: no
      async: 3600  # Allow up to 1 hour for large files
      poll: 0  # Don't wait, continue with other tasks
      register: db_copy_job
      when: db_dump_file is defined

    - name: Ensure base directory exists
      file:
        path: "{{ base_dir }}"
        state: directory
        mode: '0755'

    - name: Include Security role (SSH hardening, fail2ban, firewall)
      include_role:
        name: security

    - name: Include Docker role
      include_role:
        name: docker

    - name: Build magenta-arthel base image
      include_role:
        name: build-image

    - name: Include PostgreSQL role
      include_role:
        name: postgres

    - name: Include data-migration role
      include_role:
        name: data-migration

    - name: Include Caddy role for reverse proxy
      include_role:
        name: caddy

    - name: Include SSH router role
      include_role:
        name: ssh-router

    - name: Include services role (MCP server, Memory Lane, Watcher)
      include_role:
        name: services

    - name: Include user-instance role for each user
      include_role:
        name: user-instance
      loop: "{{ users }}"
      loop_control:
        loop_var: user

    - name: Create backupuser for database backups
      user:
        name: backupuser
        shell: /bin/bash
        create_home: yes

    - name: Fetch maybelle's backup public key
      slurp:
        src: /var/jenkins_home/.ssh/id_ed25519_backup.pub
      register: maybelle_backup_key
      delegate_to: maybelle.cryptograss.live

    - name: Install maybelle's backup key for backupuser
      authorized_key:
        user: backupuser
        key: "{{ maybelle_backup_key.content | b64decode }}"
        state: present

    - name: Create backup directory
      file:
        path: /var/backups/magenta
        state: directory
        mode: '0755'
        owner: backupuser
        group: backupuser

    - name: Copy database backup script
      copy:
        src: "{{ playbook_dir }}/../scripts/backup-database.sh"
        dest: /usr/local/bin/backup-magenta-db
        mode: '0755'

    - name: Install daily database backup cron job
      cron:
        name: "Backup magenta database"
        hour: "2"
        minute: "0"
        job: "/usr/local/bin/backup-magenta-db >> /var/log/magenta-backup.log 2>&1"
        user: root

    - name: Final verification - count messages in database
      shell: docker exec magenta-postgres psql -U magent -d magenta_memory -t -c "SELECT COUNT(*) FROM conversations_message;"
      register: final_message_count
      ignore_errors: yes

    - name: Display deployment summary
      debug:
        msg: |
          ============================================
          DEPLOYMENT COMPLETE
          ============================================
          Database: magenta_memory
          Message count: {{ final_message_count.stdout | trim if final_message_count is defined and not final_message_count.failed else 'ERROR' }}
          Expected count: {{ expected_message_count | default('N/A - no migration performed') }}
          Status: {{ 'VERIFIED âœ“' if (expected_message_count is defined and final_message_count.stdout | trim == expected_message_count) else 'WARNING - counts do not match!' if expected_message_count is defined else 'No migration to verify' }}

          User instances deployed:
          {% for user in users %}
          - {{ user.name }}: ssh {{ user.name }}@hunter.cryptograss.live (port {{ user.ssh_port }})
          {% endfor %}

          Next steps:
          - SSH to container: ssh justin@hunter.cryptograss.live
          - Test MCP bootstrap on fresh Claude Code session
          - Verify WAKEUP.md and CLAUDE.md are accessible
          ============================================
